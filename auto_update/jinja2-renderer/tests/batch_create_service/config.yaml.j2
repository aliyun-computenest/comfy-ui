{%- set ArtifactDisplayName = ModelNameSuffix.replace('.', '_') -%}

Service:
  DeployType: ros
  DeployMetadata:
    SupplierDeployMetadata:
      DeployTimeout: 7200
      ArtifactRelation:
        {{ EcsImageName }}:
          ArtifactId: ${Artifact.Artifact_1.ArtifactId}
          ArtifactVersion: 'draft'
      FileArtifactRelation:
        {% raw %}'{{ computenest::file::kubectl }}'{% endraw %}:
          ArtifactId: artifact-2cd0e35a3a3d45a78938
          ArtifactVersion: '1'
        {% raw %}'{{ computenest::file::template-j2 }}'{% endraw %}:
          ArtifactId: ${Artifact.Artifact_2.ArtifactId}
          ArtifactVersion: 'draft'
        {% raw %}'{{ computenest::file::ossutil }}'{% endraw %}:
          ArtifactId: artifact-02f42b30ffd44e1fa20e
          ArtifactVersion: '1'
        {% raw %}'{{ computenest::file::jinja2 }}'{% endraw %}:
          ArtifactId: artifact-d2cefb483e2749ed8641
          ArtifactVersion: '2'
    TemplateConfigs:
      - Name: {{ ArtifactDisplayName }}_æ¨¡æ¿
        Url: ros_templates/template.yaml
        AllowedRegions:
          - cn-hangzhou
          - cn-beijing
          - cn-shanghai
          - cn-hongkong
          - ap-southeast-1
          - cn-wulanchabu
        PredefinedParameters: []
        DeployScene: ACK_EXIST
        OutputConfigs:
          - OutputKey: __biubiu__
            EnableWebProxy: false
    NetworkMetadata:
      EnablePrivateVpcConnection: false
      EnableReversePrivateVpcConnection: false
    ServiceInstanceNameRule:
      UseDefaultValue: false
  ServiceType: private
  ShareType: Public
  ApprovalType: Manual
  ServiceInfo:
    - Agreements: [ ]
      Image: resources/service_logo.png
      Locale: zh-CN
      Softwares: [ ]
Artifact:
  Artifact_1:
    ArtifactType: EcsImage
    ArtifactName: {{ ArtifactDisplayName }}
    Description: {{ ArtifactDisplayName }}æ¨¡å‹é•œåƒï¼Œæ”¯æŒå¤šåœ°åŸŸ
    ArtifactProperty:
      RegionId: ${ImageBuilder.EcsImage.RegionId}
      ImageId: ${ImageBuilder.EcsImage.SourceImageId}
    SupportRegionIds:
      - cn-beijing
      - cn-hangzhou
      - ap-southeast-1
      - cn-hongkong
      - cn-shanghai
      - cn-wulanchabu
  Artifact_2:
    ArtifactType: File
    ArtifactName: {{ ArtifactDisplayName }}_k8s_resource
    Description: {{ ArtifactDisplayName }}_æ¨¡å‹K8sèµ„æºæ–‡ä»¶
    ArtifactProperty:
      RegionId: cn-hangzhou
      Url: resources/file/k8s-resource.yaml
    SupportRegionIds:
      - cn-beijing
      - cn-hangzhou
      - ap-southeast-1
      - cn-hongkong
      - cn-shanghai
      - cn-wulanchabu
ImageBuilder:
  EcsImage:
    RegionId: cn-hangzhou
    SourceImageId: m-bp1huipf6yv8qviaxjk6
    TargetImageName: {{ ArtifactDisplayName }}
    SystemDiskSize: {{ SystemDiskSize }}
    InstanceType: ecs.c7.large
    CommandType: RunShellScript
    ZoneId: cn-hangzhou-k
    SecurityGroupId: sg-bp141arf6chgiy94wxfz
    VSwitchId: vsw-bp1ldot9fiz8sj26jekwi
    InternetMaxBandwidthOut: 100
    Timeout: 10800
    Tags: []
    CommandContent: |-
      #!/bin/bash

      set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
      yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
        yum makecache
        yum install -y wget curl unzip git jq
        yum install -y docker-ce
        systemctl start docker || error "å¯åŠ¨ Docker æœåŠ¡å¤±è´¥"
        systemctl enable docker || warn "è®¾ç½® Docker å¼€æœºè‡ªå¯åŠ¨å¤±è´¥"
        sleep 20

      MODEL_PATH="/root/llm-model/{{ ModelName }}"

      # æ£€æŸ¥å·¥å…·
      command -v git >/dev/null || { echo "è¯·å®‰è£… git"; exit 1; }
      command -v git-lfs >/dev/null || { echo "è¯·å®‰è£… git-lfs"; exit 1; }
      command -v docker >/dev/null || { echo "è¯·å®‰è£… docker"; exit 1; }
      command -v docker compose >/dev/null || { echo "è¯·å®‰è£… docker-compose"; exit 1; }

      # é…ç½®hosts
      echo "é…ç½®hosts..."
      grep -q "10.0.6.32 www.modelscope.cn" /etc/hosts || echo '10.0.6.32 www.modelscope.cn' >> /etc/hosts

      # æ¸…ç†ç°æœ‰æ–‡ä»¶
      if [ -d "/root/llm-model" ]; then
          echo "åˆ é™¤ç°æœ‰æ–‡ä»¶..."
          rm -rf /root/llm-model
      fi

      # åŠ¨æ€æ£€æŸ¥ç£ç›˜ç©ºé—´ï¼ˆå…ˆå…‹éš†å†æ£€æŸ¥LFSå¤§å°ï¼‰
      echo "åˆ›å»ºç›®å½•..."
      mkdir -p "$(dirname "$MODEL_PATH")"

      echo "å…‹éš†ä»“åº“ï¼ˆä¸ä¸‹è½½LFSæ–‡ä»¶ï¼‰..."
      REPO_URL="https://www.modelscope.cn/{{ ModelName }}.git"
      if ! GIT_LFS_SKIP_SMUDGE=1 git clone --progress "$REPO_URL" "$MODEL_PATH"; then
          echo "é”™è¯¯: ä»“åº“å…‹éš†å¤±è´¥"
          exit 1
      fi
      cd "$MODEL_PATH"
      echo "æ£€æŸ¥LFSæ–‡ä»¶å¤§å°..."
      if git lfs ls-files --size 2>/dev/null | grep -v "^$"; then
          # ç®€å•è®¡ç®—ï¼šæå–æ‰€æœ‰GBæ•°å­—å¹¶ç›¸åŠ 
          TOTAL_GB=$(git lfs ls-files --size | grep -o '([0-9.]*[[:space:]]*GB)' | grep -o '[0-9.]*' | awk '{sum += $1} END {print int(sum+0.5)}')
          if [ -z "$TOTAL_GB" ] || [ "$TOTAL_GB" -eq 0 ]; then
              TOTAL_GB=20  # é»˜è®¤20GB
          fi
          REQUIRED_GB=$((TOTAL_GB + 5))  # åŠ 5GBç¼“å†²
          echo "LFSæ–‡ä»¶æ€»å¤§å°çº¦: ${TOTAL_GB}GBï¼Œéœ€è¦ç©ºé—´: ${REQUIRED_GB}GB"
          AVAILABLE_GB=$(df /root | tail -1 | awk '{print int($4/1024/1024)}')
          if [ "$AVAILABLE_GB" -lt "$REQUIRED_GB" ]; then
              echo "é”™è¯¯: ç£ç›˜ç©ºé—´ä¸è¶³! å¯ç”¨: ${AVAILABLE_GB}GB, éœ€è¦: ${REQUIRED_GB}GB"
              exit 1
          fi
          echo "ç£ç›˜ç©ºé—´æ£€æŸ¥é€šè¿‡: ${AVAILABLE_GB}GB å¯ç”¨"
      else
          echo "æœªæ£€æµ‹åˆ°LFSæ–‡ä»¶"
      fi

      # ä¸‹è½½LFSæ–‡ä»¶
      echo "ä¸‹è½½LFSæ–‡ä»¶..."
      git config lfs.progress true

      if ! git lfs pull; then
          echo "é”™è¯¯: LFSæ–‡ä»¶ä¸‹è½½å¤±è´¥"
          exit 1
      fi

      echo "ä¸‹è½½å®Œæˆ! æ¨¡å‹è·¯å¾„: $MODEL_PATH"

      # ==================== å¤„ç†æ¨¡å‹æ–‡ä»¶ç§»åŠ¨ ====================

      echo "å¼€å§‹å¤„ç†æ¨¡å‹æ–‡ä»¶ç§»åŠ¨..."

      # åˆ›å»ºå­˜å‚¨ç›®å½•ï¼ˆæå‰åˆ›å»ºï¼Œç¡®ä¿åç»­ç§»åŠ¨æ“ä½œæˆåŠŸï¼‰
      echo "åˆ›å»ºå­˜å‚¨ç›®å½•..."
      mkdir -p /root/storage/{models,output,user_scripts,user,input}

      # æ£€æŸ¥å¹¶ç§»åŠ¨ split_files ç›®å½•ä¸‹çš„æ–‡ä»¶å¤¹
      SPLIT_FILES_PATH="$MODEL_PATH/split_files"
      if [ -d "$SPLIT_FILES_PATH" ]; then
          echo "å‘ç° split_files ç›®å½•ï¼Œå¼€å§‹ç§»åŠ¨æ¨¡å‹æ–‡ä»¶..."

          # éå† split_files ç›®å½•ä¸‹çš„æ‰€æœ‰å­ç›®å½•
          for dir in "$SPLIT_FILES_PATH"/*; do
              if [ -d "$dir" ]; then
                  dir_name=$(basename "$dir")
                  target_path="/root/storage/models/$dir_name"

                  echo "ç§»åŠ¨ $dir_name åˆ° $target_path"

                  # å¦‚æœç›®æ ‡ç›®å½•å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤
                  if [ -d "$target_path" ]; then
                      echo "ç›®æ ‡ç›®å½•å·²å­˜åœ¨ï¼Œåˆ é™¤æ—§ç‰ˆæœ¬: $target_path"
                      rm -rf "$target_path"
                  fi

                  # ç§»åŠ¨ç›®å½•
                  if mv "$dir" "$target_path"; then
                      echo "âœ… æˆåŠŸç§»åŠ¨: $dir_name"
                  else
                      echo "âŒ ç§»åŠ¨å¤±è´¥: $dir_name"
                      exit 1
                  fi
              fi
          done

          echo "âœ… æ¨¡å‹æ–‡ä»¶ç§»åŠ¨å®Œæˆ!"
          echo "ğŸ“ æ¨¡å‹æ–‡ä»¶ä½ç½®: /root/storage/models/"

          # æ˜¾ç¤ºç§»åŠ¨åçš„ç›®å½•ç»“æ„
          echo "ğŸ“‹ ç§»åŠ¨åçš„æ¨¡å‹ç›®å½•ç»“æ„:"
          ls -la /root/storage/models/

      else
          echo "âš ï¸  æœªå‘ç° split_files ç›®å½•ï¼Œè·³è¿‡æ¨¡å‹æ–‡ä»¶ç§»åŠ¨"
          echo "ğŸ“ å½“å‰æ¨¡å‹ç›®å½•å†…å®¹:"
          ls -la "$MODEL_PATH"
      fi

      # ==================== ComfyUI éƒ¨ç½²éƒ¨åˆ† ====================

      echo "å¼€å§‹éƒ¨ç½² ComfyUI..."

      # åˆ›å»º ComfyUI å·¥ä½œç›®å½•
      COMFYUI_DIR="/root/application/comfy/"
      mkdir -p "$COMFYUI_DIR"
      cd "$COMFYUI_DIR"

      # ç”Ÿæˆ docker-compose.yml
      echo "ç”Ÿæˆ docker-compose.yml..."
      cat > docker-compose.yml << 'EOF'
      version: '3.8'

      services:
        comfyui:
          container_name: comfy-ui
          build:
            context: .
            dockerfile: Dockerfile
          restart: unless-stopped
          ports:
            - "8188:8188"
          volumes:
            - /root/storage/models:/root/ComfyUI/models
            - /root/storage/output:/root/ComfyUI/output
            - /root/storage/user_scripts:/root/ComfyUI/user_scripts
            - /root/storage/user:/root/ComfyUI/user
            - /root/storage/input:/root/ComfyUI/input
          deploy:
            resources:
              reservations:
                devices:
                  - driver: nvidia
                    count: all
                    capabilities: [ gpu ]
      EOF

      # ç”Ÿæˆ Dockerfile
      echo "ç”Ÿæˆ Dockerfile..."
      cat > Dockerfile << 'EOF'
      # ä½¿ç”¨é˜¿é‡Œäº‘é¢„è£…CUDA 12.4å’ŒPyTorchçš„åŸºç¡€é•œåƒ
      FROM mirrors-ssl.aliyuncs.com/egs-registry.cn-hangzhou.cr.aliyuncs.com/egs/vllm:0.7.2-pytorch2.5.1-cuda12.4-ubuntu22.04

      LABEL maintainer="renyun"

      # è®¾ç½®APTé•œåƒæºï¼ˆé˜¿é‡Œäº‘æºï¼‰
      RUN sed -i 's/archive.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list && \
          sed -i 's/security.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list

      # å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆåŸºäºUbuntu 22.04ï¼‰
      RUN apt-get update && \
          DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
          ffmpeg libsm6 libxext6 libgl1 libglib2.0-0 \
          git ninja-build aria2 wget

      # å®‰è£…Pythonä¾èµ–ï¼ˆå¤ç”¨åŸºç¡€é•œåƒå·²å®‰è£…çš„torch/vllmï¼‰
      RUN pip install --no-cache-dir \
          opencv-python-headless \
          scikit-learn \
          matplotlib \
          pandas \
          numba \
          xformers \
          "numpy<1.25" \
          SageAttention \
          Cython \
          py-build-cmake \
          aiohttp \
          ffmpeg-python \
          GitPython \
          joblib \
          lark \
          matplotlib \
          mpmath \
          onnx \
          pandas \
          qrcode \
          rich \
          scipy svglib \
          gradio>=5.0.0

      # åˆ›å»ºå·¥ä½œç›®å½•å¹¶å…‹éš†ä»“åº“
      WORKDIR /root
      COPY download_custom_nodes_script.sh download_custom_nodes_script.sh
      RUN date > /tmp/build_time
      RUN chmod +x download_custom_nodes_script.sh && ./download_custom_nodes_script.sh

      # ä¼˜åŒ–å®¹å™¨é…ç½®
      EXPOSE 8188
      WORKDIR /root/ComfyUI

      # å¯åŠ¨å‘½ä»¤
      CMD ["python3", "main.py", "--listen", "--port", "8188", "--fast"]
      EOF

      cat > download_custom_nodes_script.sh << 'EOF'
      #!/bin/bash
      set -euo pipefail
      function clone_and_install () {
          local original_dir=$(pwd)
          local url="$1"
          local repo_name=$(basename "$url" .git)

          # å…‹éš†é˜¶æ®µ
          echo "ğŸ”» å¼€å§‹å…‹éš†: $repo_name"
          if ! git clone --depth=1 --no-tags --recurse-submodules --shallow-submodules "$url"; then
              echo "âŒ å…‹éš†å¤±è´¥: $url" >&2
              return 1
          fi
          # å®‰è£…ä¾èµ–é˜¶æ®µ
          echo "ğŸ“‚ è¿›å…¥ç›®å½•: $repo_name"
          cd "$repo_name" || return 2
          if [[ -f requirements.txt ]]; then
              echo "ğŸ”§ å®‰è£…ä¾èµ–: $repo_name"
              pip install -r requirements.txt > /dev/null
          else
              echo "â“˜ æœªæ‰¾åˆ° requirements.txt"
          fi

          # è¿”å›åŸç›®å½•
          echo "â†©ï¸ è¿”å›ä¸Šçº§ç›®å½•"
          cd "$original_dir"

          # è¿”å›å®Œæ•´è·¯å¾„
          echo "$(pwd)/$repo_name"
          echo "âœ… å®Œæˆå¤„ç†: $repo_name"
          echo "----------------------------------"
      }

      function clone () {
            set +e ;
            git clone --depth=1 --no-tags --recurse-submodules --shallow-submodules "$1";
            set -e ;
      }

      cd /root
      clone https://github.com/comfyanonymous/ComfyUI.git
      cd /root/ComfyUI
      pip install -r requirements.txt
      cd /root/ComfyUI/custom_nodes
      clone_and_install https://github.com/ltdrdata/ComfyUI-Manager.git
      clone_and_install https://github.com/kijai/ComfyUI-WanVideoWrapper.git
      clone_and_install https://github.com/crystian/ComfyUI-Crystools.git
      clone_and_install https://github.com/crystian/ComfyUI-Crystools-save.git
      clone_and_install https://github.com/Wan-Video/Wan2.1.git
      clone_and_install https://github.com/Suzie1/ComfyUI_Comfyroll_CustomNodes.git
      clone_and_install https://github.com/ltdrdata/ComfyUI-Impact-Pack.git
      clone_and_install https://github.com/welltop-cn/ComfyUI-TeaCache.git
      clone_and_install https://github.com/sh570655308/ComfyUI-TopazVideoAI.git
      # General
      clone_and_install https://github.com/cubiq/ComfyUI_InstantID.git
      clone_and_install https://github.com/pythongosssss/ComfyUI-Custom-Scripts.git
      clone_and_install https://github.com/bash-j/mikey_nodes.git
      clone_and_install https://github.com/kijai/ComfyUI-GIMM-VFI.git
      clone_and_install https://github.com/liusida/ComfyUI-Login.git
      clone_and_install https://github.com/city96/ComfyUI-GGUF.git
      rm -rf /root/ComfyUI/custom_nodes/login

      clone https://github.com/chrisgoringe/cg-use-everywhere.git
      clone https://github.com/cubiq/ComfyUI_essentials.git
      clone https://github.com/jags111/efficiency-nodes-comfyui.git
      clone https://github.com/kijai/ComfyUI-KJNodes.git
      clone https://github.com/rgthree/rgthree-comfy.git
      clone https://github.com/shiimizu/ComfyUI_smZNodes.git
      clone https://github.com/WASasquatch/was-node-suite-comfyui.git

      clone https://github.com/cubiq/PuLID_ComfyUI.git
      clone https://github.com/Fannovel16/comfyui_controlnet_aux.git
      clone https://github.com/florestefano1975/comfyui-portrait-master.git
      clone https://github.com/Gourieff/ComfyUI-ReActor.git
      clone https://github.com/huchenlei/ComfyUI-layerdiffuse.git
      clone https://github.com/Kosinkadink/ComfyUI-Advanced-ControlNet.git
      clone https://github.com/ltdrdata/ComfyUI-Inspire-Pack.git
      clone https://github.com/mcmonkeyprojects/sd-dynamic-thresholding.git
      clone https://github.com/twri/sdxl_prompt_styler.git
      EOF
      # è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
      chmod +x download_custom_nodes_script.sh
      # æ„å»ºå¹¶å¯åŠ¨ ComfyUI
      echo "æ„å»ºå¹¶å¯åŠ¨ ComfyUI å®¹å™¨..."
      docker-compose up -d --build
      echo "ç­‰å¾…å®¹å™¨å¯åŠ¨..."
      sleep 10
      # æ£€æŸ¥å®¹å™¨çŠ¶æ€
      if docker ps | grep -q "comfy-ui"; then
          echo "ğŸ“‹ æœ€ç»ˆæ¨¡å‹ç›®å½•ç»“æ„:"
          if [ -d "/root/storage/models" ] && [ "$(ls -A /root/storage/models)" ]; then
              ls -la /root/storage/models/
          else
              echo "æ¨¡å‹ç›®å½•ä¸ºç©º"
          fi
      else
          echo "âŒ ComfyUI éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—:"
          docker-compose logs
          exit 1
      fi
